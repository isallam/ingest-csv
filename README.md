# ingest-csv

This project allow users to ingest any CSV file's data using a description of mapping between elements in the CSV file and the Schema in Thingspan database.

For an example of the mapping file see .json files in the the config directory in conjunction with the allschema.txt file which is used to create the schema.

## The JSON mapper format
There are various elements in the JSON file to all the code to process the CSV. The JSON mapper can be used with any CSV file as long as the raw data items defined in the mapper is available in the CSV file.

In general any CSV file will provide

  1. The main class (type) to ingest. 
  2. Relationship to other classes (types)
  3. Dependent classes (types) that partially present in the file

For example people.csv include person information only, but address.csv include, address information, location information and also relationship to the person owning the address (house/business)

The Mapper sections are
- "ClassName" : the main class that need to be generated from the CSV
- "ClassKey"  : (optional) What identify the uniqueness of the object so a second process of the same file doesn duplicate the data.
- "Integers"  : list of integer attributes in the schema and their corresponding columns name in the CSV file
- "Strings"   : list of string attributes... (same as above)
- "Floats"    : list of float attributes... (same as above)
- "Dates"     : list of DateTime attributes... (same as above) [this type of attributes might not be fully implemented yet]
- "Relationships" : list of class relationship details, here are the relationship elements
    - "RelationshipName": name of the schema attribute that reference the relationship
    - "ToClass"         : target type of the relationship
    - "ToClassRelationshipName" : (optional) if there is a reverse relationship, this is the name
    - "Key"             : a list of keys that represent the uniqueness of the related object and how they map from 
                        schema attribute name to csv file column name
                        (see AddressMapper.json for a complex type of keys)
                        

## To run the test

1. execute the re-createfd script
```
   cd data
   ./recreatefd.sh
   cd ..
```   
2. make sure you have data generated by "training-datagen" in the sourcedata directory.
3. run "gradle tasks" to see which tasks are available.
```
   e.g.
      gradle testIngestPhoneCalls
```
4. Any of the tesks can be run in any order, no new data will be added to the database if it's already ingested from the raw files
   (there is still one issue with the to-many relationship, there is no check to see if the data already existed in the list)
   
   
